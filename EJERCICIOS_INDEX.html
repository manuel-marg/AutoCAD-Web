<!DOCTYPE html>
<html class="light" lang="es">
<head>
  <base target="_top">
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>Plataforma de Ejercicios Académicos</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link href="https://fonts.googleapis.com" rel="preconnect"/>
  <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
  <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@100..900&amp;display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet"/>
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            "primary": "#1d73ed",
            "background-light": "#f6f7f8",
            "background-dark": "#101722",
            "card-dark": "#18212f",
            "border-dark": "#2a3546",
          },
          fontFamily: { "display": ["Lexend", "sans-serif"] },
          borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px" },
        },
      },
    }
  </script>
  <style>
    .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24 }
    .hidden { display: none; }
  </style>
</head>
<body class="font-display bg-background-light dark:bg-background-dark text-gray-800 dark:text-gray-200">

  <header class="bg-white dark:bg-card-dark border-b border-gray-200 dark:border-border-dark p-4 shadow-sm sticky top-0 z-10">
    <div class="flex justify-between items-center max-w-7xl mx-auto">
      <div class="flex items-center gap-3">
        <span class="material-symbols-outlined text-primary text-3xl">school</span>
        <h1 class="text-gray-900 dark:text-white text-xl font-semibold">Plataforma Académica</h1>
      </div>
      <button id="adminBtn" onclick="showAdminLogin()" class="flex items-center justify-center gap-2 rounded-lg h-10 px-4 bg-primary/10 dark:bg-primary/20 text-primary text-sm font-bold hover:bg-primary/20 dark:hover:bg-primary/30 transition-colors">
        <span class="material-symbols-outlined text-base">admin_panel_settings</span>
        <span>Admin</span>
      </button>
    </div>
  </header>

  <main class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto">

      <!-- Vista Pública de Ejercicios -->
      <div id="publicView">
        <div class="flex flex-wrap justify-between items-center gap-4 mb-6">
          <div class="flex flex-col gap-1">
            <h1 class="text-gray-900 dark:text-white text-3xl font-bold tracking-tight">Ejercicios Disponibles</h1>
            <p class="text-gray-600 dark:text-gray-400 text-base">Busca y descarga los materiales que necesites.</p>
          </div>
        </div>

        <div class="bg-white dark:bg-card-dark dark:border dark:border-border-dark rounded-xl shadow-sm p-4">
          <div class="flex-1 mb-4">
            <label class="flex flex-col min-w-40 w-full">
              <div class="flex w-full flex-1 items-stretch rounded-lg h-10">
                <div class="text-gray-500 dark:text-gray-400 flex border border-r-0 border-gray-200 dark:border-border-dark bg-background-light dark:bg-background-dark items-center justify-center pl-3 rounded-l-lg">
                  <span class="material-symbols-outlined">search</span>
                </div>
                <input id="searchInput" onkeyup="filterTable()" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-gray-900 dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-gray-200 dark:border-border-dark bg-background-light dark:bg-background-dark h-full placeholder:text-gray-500 px-4 rounded-l-none border-l-0 pl-2 text-sm" placeholder="Buscar por nombre de ejercicio..."/>
              </div>
            </label>
          </div>

          <div id="loadingPublic" class="p-4 text-center text-gray-500">Cargando ejercicios...</div>
          
          <div class="overflow-x-auto">
            <table id="publicTable" class="w-full">
              <thead>
                <tr class="border-b border-b-gray-200 dark:border-b-border-dark">
                  <th class="px-4 py-3 text-left text-gray-500 dark:text-gray-400 text-xs font-medium uppercase tracking-wider">Nombre</th>
                  <th class="px-4 py-3 text-left text-gray-500 dark:text-gray-400 text-xs font-medium uppercase tracking-wider">Archivo</th>
                  <th class="px-4 py-3 text-left text-gray-500 dark:text-gray-400 text-xs font-medium uppercase tracking-wider">Fecha de Subida</th>
                  <th class="px-4 py-3 text-left text-gray-500 dark:text-gray-400 text-xs font-medium uppercase tracking-wider">Descargas</th>
                  <th class="px-4 py-3 text-left text-gray-500 dark:text-gray-400 text-xs font-medium uppercase tracking-wider">Acción</th>
                </tr>
              </thead>
              <tbody id="ejerciciosPublicBody" class="divide-y divide-gray-200 dark:divide-border-dark">
              </tbody>
            </table>
          </div>
          <div id="noResults" class="hidden p-4 text-center text-gray-500">No se encontraron ejercicios que coincidan con la búsqueda.</div>
        </div>
      </div>

      <!-- Formulario de Login para Admin -->
      <div id="loginForm" class="hidden fixed inset-0 bg-black/30 z-20 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-card-dark rounded-xl shadow-lg w-full max-w-md p-8">
          <h2 class="text-2xl font-bold text-center text-gray-900 dark:text-white mb-6">Acceso Administrativo</h2>
          <div class="space-y-4">
            <div>
              <label for="adminUser" class="text-sm font-medium text-gray-700 dark:text-gray-300">Usuario</label>
              <input type="text" id="adminUser" placeholder="admin" class="mt-1 form-input w-full rounded-lg border-gray-300 dark:border-border-dark bg-background-light dark:bg-background-dark focus:ring-primary/50 focus:border-primary dark:text-white">
            </div>
            <div>
              <label for="adminPass" class="text-sm font-medium text-gray-700 dark:text-gray-300">Contraseña</label>
              <input type="password" id="adminPass" placeholder="••••••••" class="mt-1 form-input w-full rounded-lg border-gray-300 dark:border-border-dark bg-background-light dark:bg-background-dark focus:ring-primary/50 focus:border-primary dark:text-white">
            </div>
          </div>
          <div id="loginMessage" class="mt-4 text-sm text-center"></div>
          <div class="mt-6 flex flex-col gap-3">
            <button onclick="login()" class="w-full flex items-center justify-center gap-2 rounded-lg h-10 px-4 bg-primary text-white text-sm font-bold hover:bg-primary/90 transition-colors">Iniciar Sesión</button>
            <button onclick="hideAdminView()" class="w-full flex items-center justify-center gap-2 rounded-lg h-10 px-4 bg-gray-200 dark:bg-border-dark text-gray-800 dark:text-gray-200 text-sm font-bold hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">Cancelar</button>
          </div>
        </div>
      </div>

      <!-- Panel de Administración -->
      <div id="adminPanel" class="hidden">
        <div class="flex flex-wrap justify-between items-center gap-4 mb-6">
          <div class="flex flex-col gap-1">
            <h1 class="text-gray-900 dark:text-white text-3xl font-bold tracking-tight">Panel de Administración</h1>
            <p class="text-gray-600 dark:text-gray-400 text-base">Gestiona los ejercicios de la plataforma.</p>
          </div>
          <button onclick="logout()" class="flex items-center justify-center gap-2 rounded-lg h-10 px-4 bg-red-500/10 text-red-500 text-sm font-bold hover:bg-red-500/20 transition-colors">
            <span class="material-symbols-outlined text-base">logout</span>
            <span>Cerrar Sesión</span>
          </button>
        </div>

        <div class="border-b border-gray-200 dark:border-border-dark mb-4">
          <nav class="-mb-px flex space-x-6" id="admin-nav">
            <button onclick="showAdminSection('upload')" class="py-4 px-1 border-b-2 border-primary text-primary font-medium text-sm">Subir Ejercicio</button>
            <button onclick="showAdminSection('list')" class="py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-200 dark:hover:border-gray-600 font-medium text-sm">Lista de Ejercicios</button>
          </nav>
        </div>

        <div id="adminMessage" class="mb-4"></div>

        <div id="uploadSection" class="bg-white dark:bg-card-dark dark:border dark:border-border-dark rounded-xl shadow-sm p-6">
          <h2 class="text-xl font-bold mb-4">Subir Nuevo Ejercicio</h2>
          <div class="space-y-4">
            <div>
              <label for="nombreEjercicio" class="text-sm font-medium">Nombre del Ejercicio</label>
              <input type="text" id="nombreEjercicio" placeholder="Ej. Guía de Cálculo I" class="mt-1 form-input w-full rounded-lg border-gray-300 dark:border-border-dark bg-background-light dark:bg-background-dark focus:ring-primary/50 focus:border-primary dark:text-white">
            </div>
            <div>
              <label for="archivoEjercicio" class="text-sm font-medium">Archivo PDF</label>
              <input type="file" id="archivoEjercicio" accept=".pdf" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-primary/10 file:text-primary hover:file:bg-primary/20">
              <div id="archivoInfo" class="hidden mt-2 text-xs p-2 bg-gray-100 dark:bg-background-dark rounded-md"></div>
            </div>
            <div class="flex justify-end">
              <button onclick="subirEjercicio()" class="flex items-center justify-center gap-2 rounded-lg h-10 px-4 bg-primary text-white text-sm font-bold hover:bg-primary/90 transition-colors">
                <span class="material-symbols-outlined text-base">upload</span>
                <span>Subir Ejercicio</span>
              </button>
            </div>
          </div>
           <div id="uploadMessage" class="mt-4"></div>
        </div>

        <div id="listSection" class="hidden">
          <div id="loadingAdmin" class="p-4 text-center text-gray-500">Cargando ejercicios...</div>
          <div id="ejerciciosAdmin" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Admin cards go here -->
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    let isAuthenticated = false;
    let ejerciciosData = [];

    function initializeApp() {
      loadPublicEjercicios();
      document.getElementById('archivoEjercicio').addEventListener('change', handleFileSelect);
    }

    function loadPublicEjercicios() {
      document.getElementById('loadingPublic').classList.remove('hidden');
      google.script.run
        .withSuccessHandler(function(data) {
          ejerciciosData = data.sort((a, b) => new Date(b.fechaSubida) - new Date(a.fechaSubida));
          displayPublicEjercicios(ejerciciosData);
          document.getElementById('loadingPublic').classList.add('hidden');
        })
        .withFailureHandler(error => showMessage('loadingPublic', 'Error al cargar ejercicios: ' + error.message, 'error'))
        .obtenerEjercicios();
    }

    function displayPublicEjercicios(ejercicios) {
      const tableBody = document.getElementById('ejerciciosPublicBody');
      tableBody.innerHTML = '';
      if (ejercicios.length === 0) {
        const tr = tableBody.insertRow();
        tr.innerHTML = `<td colspan="5" class="text-center py-8 text-gray-500">No hay ejercicios disponibles aún.</td>`;
        return;
      }
      ejercicios.forEach(ejercicio => {
        const tr = tableBody.insertRow();
        tr.innerHTML = `
          <td class="px-4 py-3 text-sm font-medium text-gray-900 dark:text-white">${ejercicio.nombre}</td>
          <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-400">${ejercicio.nombreOriginal}</td>
          <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-400">${ejercicio.fechaSubida}</td>
          <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-400">${ejercicio.descargas}</td>
          <td class="px-4 py-3 text-sm"><button class="font-bold text-primary hover:underline" onclick="descargarEjercicio('${ejercicio.id}', '${ejercicio.url}')">Descargar</button></td>
        `;
      });
    }

    function filterTable() {
      const filter = document.getElementById("searchInput").value.toUpperCase();
      const rows = document.getElementById("ejerciciosPublicBody").getElementsByTagName("tr");
      let found = false;
      Array.from(rows).forEach(row => {
        const nameCell = row.getElementsByTagName("td")[0];
        if (nameCell) {
          const txtValue = nameCell.textContent || nameCell.innerText;
          if (txtValue.toUpperCase().indexOf(filter) > -1) {
            row.style.display = "";
            found = true;
          } else {
            row.style.display = "none";
          }
        }
      });
      document.getElementById('noResults').style.display = found || rows.length === 0 ? 'none' : 'block';
    }

    function handleFileSelect(event) {
      const file = event.target.files[0];
      const infoDiv = document.getElementById('archivoInfo');
      if (file) {
        if (file.type !== 'application/pdf') {
          infoDiv.innerHTML = `<span class="text-red-500">Solo se permiten archivos PDF</span>`;
          infoDiv.classList.remove('hidden');
          return;
        }
        infoDiv.innerHTML = `Archivo: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
        infoDiv.classList.remove('hidden');
      } else {
        infoDiv.classList.add('hidden');
      }
    }

    function subirEjercicio() {
      const nombre = document.getElementById('nombreEjercicio').value.trim();
      const file = document.getElementById('archivoEjercicio').files[0];
      if (!nombre) { showMessage('uploadMessage', 'Por favor ingrese el nombre del ejercicio.', 'error'); return; }
      if (!file) { showMessage('uploadMessage', 'Por favor seleccione un archivo PDF.', 'error'); return; }
      if (file.type !== 'application/pdf') { showMessage('uploadMessage', 'Solo se permiten archivos PDF.', 'error'); return; }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        const datos = {
          nombre: nombre,
          archivoBase64: e.target.result.split(',')[1],
          tipoArchivo: file.type,
          nombreOriginal: file.name,
          tamano: file.size
        };
        showMessage('uploadMessage', 'Subiendo archivo, por favor espere...', 'info');
        google.script.run
          .withSuccessHandler(result => {
            if (result.exito) {
              showMessage('uploadMessage', result.mensaje, 'success');
              document.getElementById('nombreEjercicio').value = '';
              document.getElementById('archivoEjercicio').value = '';
              document.getElementById('archivoInfo').classList.add('hidden');
              loadPublicEjercicios();
              loadAdminEjercicios();
            } else {
              showMessage('uploadMessage', result.mensaje, 'error');
            }
          })
          .withFailureHandler(error => showMessage('uploadMessage', 'Error al subir: ' + error.message, 'error'))
          .subirEjercicio(datos);
      };
      reader.readAsDataURL(file);
    }

    function descargarEjercicio(id, url) {
      google.script.run.registrarDescarga(id);
      window.open(url, '_blank');
    }

    function showAdminLogin() {
      document.getElementById('loginForm').classList.remove('hidden');
    }

    function hideAdminView() {
      document.getElementById('loginForm').classList.add('hidden');
    }

    function login() {
      const usuario = document.getElementById('adminUser').value;
      const contrasena = document.getElementById('adminPass').value;
      if (!usuario || !contrasena) { showMessage('loginMessage', 'Ingrese usuario y contraseña.', 'error'); return; }
      
      showMessage('loginMessage', 'Autenticando...', 'info');
      google.script.run
        .withSuccessHandler(result => {
          if (result.autenticado) {
            isAuthenticated = true;
            document.getElementById('publicView').classList.add('hidden');
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('adminPanel').classList.remove('hidden');
            loadAdminEjercicios();
          } else {
            showMessage('loginMessage', result.mensaje, 'error');
          }
        })
        .withFailureHandler(error => showMessage('loginMessage', 'Error de autenticación: ' + error.message, 'error'))
        .autenticar(usuario, contrasena);
    }

    function logout() {
      isAuthenticated = false;
      document.getElementById('adminPanel').classList.add('hidden');
      document.getElementById('publicView').classList.remove('hidden');
      clearMessage('loginMessage');
    }

    function showAdminSection(section) {
        const buttons = document.querySelectorAll('#admin-nav button');
        buttons.forEach(button => {
            button.classList.remove('border-primary', 'text-primary');
            button.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
        });
        const selectedButton = document.querySelector(`#admin-nav button[onclick="showAdminSection('${section}')"]`);
        selectedButton.classList.add('border-primary', 'text-primary');
        selectedButton.classList.remove('border-transparent', 'text-gray-500');

        document.getElementById('uploadSection').classList.add('hidden');
        document.getElementById('listSection').classList.add('hidden');
        if (section === 'upload') {
            document.getElementById('uploadSection').classList.remove('hidden');
        } else if (section === 'list') {
            document.getElementById('listSection').classList.remove('hidden');
            loadAdminEjercicios();
        }
    }

    function loadAdminEjercicios() {
      document.getElementById('loadingAdmin').classList.remove('hidden');
      google.script.run
        .withSuccessHandler(data => {
          displayAdminEjercicios(data.sort((a, b) => new Date(b.fechaSubida) - new Date(a.fechaSubida)));
          document.getElementById('loadingAdmin').classList.add('hidden');
        })
        .withFailureHandler(error => showMessage('loadingAdmin', 'Error al cargar: ' + error.message, 'error'))
        .obtenerEjercicios();
    }

    function displayAdminEjercicios(ejercicios) {
      const container = document.getElementById('ejerciciosAdmin');
      container.innerHTML = '';
      if (ejercicios.length === 0) {
        container.innerHTML = `<div class="col-span-full text-center py-8 text-gray-500">No hay ejercicios registrados.</div>`;
        return;
      }
      ejercicios.forEach(ejercicio => {
        const card = document.createElement('div');
        card.className = 'bg-white dark:bg-card-dark dark:border dark:border-border-dark rounded-xl shadow-sm p-4 flex flex-col';
        card.innerHTML = `
          <h3 class="font-bold text-gray-900 dark:text-white mb-2">${ejercicio.nombre}</h3>
          <div class="text-xs text-gray-500 dark:text-gray-400 space-y-1 flex-grow">
            <p><strong>Archivo:</strong> ${ejercicio.nombreOriginal}</p>
            <p><strong>Subido:</strong> ${ejercicio.fechaSubida}</p>
            <p><strong>Descargas:</strong> ${ejercicio.descargas}</p>
          </div>
          <div class="mt-4 flex gap-2">
            <button onclick="editarEjercicio('${ejercicio.id}')" class="flex-1 flex items-center justify-center gap-1 rounded-lg h-8 px-3 bg-yellow-500/10 text-yellow-600 text-xs font-bold hover:bg-yellow-500/20 transition-colors">
              <span class="material-symbols-outlined text-sm">edit</span><span>Editar</span>
            </button>
            <button onclick="eliminarEjercicio('${ejercicio.id}')" class="flex-1 flex items-center justify-center gap-1 rounded-lg h-8 px-3 bg-red-500/10 text-red-500 text-xs font-bold hover:bg-red-500/20 transition-colors">
              <span class="material-symbols-outlined text-sm">delete</span><span>Eliminar</span>
            </button>
          </div>
        `;
        container.appendChild(card);
      });
    }

    function editarEjercicio(id) {
      const ejercicio = ejerciciosData.find(e => e.id === id);
      if (!ejercicio) { showMessage('adminMessage', 'Ejercicio no encontrado', 'error'); return; }
      const nuevoNombre = prompt('Editar nombre del ejercicio:', ejercicio.nombre);
      if (nuevoNombre && nuevoNombre.trim() !== '') {
        google.script.run
          .withSuccessHandler(result => {
            if (result.exito) {
              showMessage('adminMessage', 'Ejercicio actualizado.', 'success');
              loadAdminEjercicios();
              loadPublicEjercicios();
            } else {
              showMessage('adminMessage', result.mensaje, 'error');
            }
          })
          .withFailureHandler(error => showMessage('adminMessage', 'Error al actualizar: ' + error.message, 'error'))
          .actualizarEjercicio({ id: id, nombre: nuevoNombre.trim() });
      }
    }

    function eliminarEjercicio(id) {
      if (confirm('¿Está seguro que desea eliminar este ejercicio?')) {
        google.script.run
          .withSuccessHandler(result => {
            if (result.exito) {
              showMessage('adminMessage', 'Ejercicio eliminado.', 'success');
              loadAdminEjercicios();
              loadPublicEjercicios();
            } else {
              showMessage('adminMessage', result.mensaje, 'error');
            }
          })
          .withFailureHandler(error => showMessage('adminMessage', 'Error al eliminar: ' + error.message, 'error'))
          .eliminarEjercicio(id);
      }
    }

    function showMessage(containerId, message, type) {
        const el = document.getElementById(containerId);
        let color = 'blue';
        if (type === 'error') color = 'red';
        if (type === 'success') color = 'green';
        el.innerHTML = `<div class="text-${color}-500 text-sm">${message}</div>`;
    }

    function clearMessage(containerId) {
      document.getElementById(containerId).innerHTML = '';
    }

    document.addEventListener('DOMContentLoaded', initializeApp);
  </script>
</body>
</html>