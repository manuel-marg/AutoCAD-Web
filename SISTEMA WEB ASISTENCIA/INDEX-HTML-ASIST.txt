
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Control de Asistencia QR</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    :root {
      --primary: #4CAF50;
      --primary-dark: #45a049;
      --secondary: #2196F3;
      --secondary-dark: #1976D2;
      --success: #d4edda;
      --success-text: #155724;
      --error: #f8d7da;
      --error-text: #721c24;
      --warning: #fff3cd;
      --warning-text: #856404;
      --bg-main: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --shadow: 0 4px 20px rgba(0,0,0,0.15);
      --border-radius: 12px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-main);
      min-height: 100vh;
      padding: 10px;
      line-height: 1.5;
    }

    .container {
      max-width: min(500px, 100vw - 20px);
      margin: 0 auto;
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      animation: slideIn 0.5s ease-out;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .header {
      background: var(--primary);
      color: white;
      padding: clamp(15px, 4vw, 25px);
      text-align: center;
    }

    .header h1 {
      font-size: clamp(18px, 5vw, 24px);
      font-weight: 600;
      margin-bottom: 5px;
    }

    .header p {
      font-size: clamp(12px, 3vw, 14px);
      opacity: 0.9;
    }

    .content {
      padding: clamp(15px, 5vw, 30px);
    }

    .time-display {
      background: linear-gradient(45deg, #e8f5e8, #f0fff0);
      border: 2px solid var(--primary);
      border-radius: var(--border-radius);
      padding: 15px;
      text-align: center;
      margin-bottom: 20px;
      font-size: clamp(14px, 4vw, 18px);
      font-weight: 600;
      color: #2e7d32;
    }

    .camera-toggle {
      background: #f8f9fa;
      border: 2px solid #e9ecef;
      border-radius: var(--border-radius);
      padding: 15px;
      margin-bottom: 15px;
      text-align: center;
    }

    .toggle-wrapper {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 28px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: var(--transition);
      border-radius: 28px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 22px;
      width: 22px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: var(--transition);
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: var(--primary);
    }

    input:checked + .slider:before {
      transform: translateX(22px);
    }

    .camera-controls {
      display: none;
      margin-bottom: 15px;
    }

    .camera-select select {
      width: 100%;
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: var(--border-radius);
      font-size: 14px;
      background: white;
    }

    #reader {
      width: 100%;
      max-width: min(300px, 90vw);
      margin: 0 auto 20px;
      border: 2px dashed #ddd;
      border-radius: var(--border-radius);
      overflow: hidden;
      display: none;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
      font-size: clamp(14px, 3.5vw, 16px);
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: clamp(10px, 3vw, 14px);
      border: 2px solid #ddd;
      border-radius: var(--border-radius);
      font-size: clamp(14px, 4vw, 16px);
      transition: var(--transition);
      background: white;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
    }

    .btn {
      width: 100%;
      padding: clamp(12px, 3vw, 16px);
      background: var(--primary);
      color: white;
      border: none;
      border-radius: var(--border-radius);
      font-size: clamp(14px, 4vw, 16px);
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn:hover:not(:disabled) {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn-secondary {
      background: var(--secondary);
    }

    .btn-secondary:hover:not(:disabled) {
      background: var(--secondary-dark);
    }

    .employee-info {
      background: linear-gradient(45deg, #f8f9fa, #ffffff);
      border: 2px solid var(--primary);
      border-radius: var(--border-radius);
      padding: 15px;
      margin-bottom: 20px;
      display: none;
      box-shadow: 0 2px 10px rgba(76, 175, 80, 0.1);
    }

    .employee-info h3 {
      color: var(--primary);
      margin-bottom: 10px;
      font-size: clamp(16px, 4vw, 18px);
    }

    .employee-info p {
      margin: 5px 0;
      color: #6c757d;
      font-size: clamp(13px, 3vw, 14px);
    }

    .employee-info .highlight {
      font-weight: 600;
      color: #495057;
    }

    #respuesta {
      margin-top: 20px;
      padding: 15px;
      border-radius: var(--border-radius);
      text-align: center;
      font-weight: 600;
      display: none;
      font-size: clamp(13px, 3.5vw, 15px);
    }

    .success {
      background: var(--success);
      color: var(--success-text);
      border: 1px solid #c3e6cb;
    }

    .error {
      background: var(--error);
      color: var(--error-text);
      border: 1px solid #f5c6cb;
    }

    .warning {
      background: var(--warning);
      color: var(--warning-text);
      border: 1px solid #ffeaa7;
    }

    .loading {
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .qr-status {
      text-align: center;
      padding: 10px;
      margin-bottom: 15px;
      border-radius: var(--border-radius);
      background: #e3f2fd;
      color: #1565c0;
      display: none;
      font-size: clamp(12px, 3vw, 14px);
    }

    @media (max-width: 480px) {
      body {
        padding: 5px;
      }
      
      .content {
        padding: 15px;
      }
      
      .toggle-wrapper {
        justify-content: center;
      }
    }

    @media (min-width: 768px) {
      .container {
        margin-top: 20px;
      }
    }

    @media (orientation: landscape) and (max-height: 500px) {
      .header {
        padding: 10px;
      }
      
      .content {
        padding: 15px;
      }
      
      .time-display {
        margin-bottom: 10px;
        padding: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üïê QASO SYSTEM</h1>
      <p>Escanea tu c√≥digo QR o ingresa tu ID</p>
    </div>
    
    <div class="content">
      <div class="time-display" id="reloj-tiempo">üïê Cargando...</div>
      
      <div class="camera-toggle">
        <div class="toggle-wrapper">
          <span>üì∑ C√°mara:</span>
          <label class="switch">
            <input type="checkbox" id="camera-toggle" checked>
            <span class="slider"></span>
          </label>
          <span id="camera-status">Activada</span>
        </div>
      </div>
      
      <div class="qr-status" id="qr-status">üé• Iniciando c√°mara...</div>
      
      <div class="camera-controls" id="camera-controls">
        <div class="camera-select">
          <select id="camera-select">
            <option value="">Seleccione una c√°mara...</option>
          </select>
        </div>
      </div>
      
      <div id="reader"></div>
      
      <button type="button" class="btn btn-secondary" id="reiniciar-btn" onclick="reiniciarQR()" style="display: none;">
        üîÑ Reiniciar Esc√°ner
      </button>
      
      <form id="formulario">
        <div class="form-group">
          <label for="id">üÜî ID del Empleado:</label>
          <input type="text" id="id" required placeholder="Ingrese su ID">
        </div>
        
        <div class="employee-info" id="employee-info">
          <h3>üë§ Informaci√≥n del Empleado</h3>
          <p><strong>Nombre:</strong> <span id="employee-name" class="highlight">-</span></p>
          <p><strong>√Årea:</strong> <span id="employee-area" class="highlight">-</span></p>
          <p><strong>Cargo:</strong> <span id="employee-position" class="highlight">-</span></p>
        </div>
        
        <div class="form-group">
          <label for="estado">üìä Estado:</label>
          <select id="estado" required>
            <option value="INGRESO">üü¢ INGRESO</option>
            <option value="SALIDA">üî¥ SALIDA</option>
          </select>
        </div>
        
        <button type="submit" class="btn" id="btn-submit" disabled>
          ‚úÖ Registrar Asistencia
        </button>
      </form>
      
      <div id="respuesta"></div>
    </div>
  </div>

  <script>
    let qrCodeReader = null;
    let isScanning = false;
    let searchTimeout = null;
    let employeeData = null;
    let selectedCameraId = null;
    let ultimoRegistro = {};
    let cameraEnabled = true;
    
    function actualizarReloj() {
      const ahora = new Date();
      const hora = ahora.toLocaleTimeString('es-PE', {
        hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
      });
      const fecha = ahora.toLocaleDateString('es-PE', {
        weekday: 'short', day: 'numeric', month: 'short'
      });
      
      document.getElementById('reloj-tiempo').innerHTML = `üïê ${hora}<br><small>${fecha}</small>`;
    }
    
    function esMobile() {
      return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }
    
    function actualizarEstadoQR(mensaje, esError = false) {
      const statusEl = document.getElementById('qr-status');
      statusEl.textContent = mensaje;
      statusEl.style.background = esError ? '#ffebee' : '#e3f2fd';
      statusEl.style.color = esError ? '#c62828' : '#1565c0';
      statusEl.style.display = 'block';
    }
    
    function toggleCamera(enabled) {
      cameraEnabled = enabled;
      const statusSpan = document.getElementById('camera-status');
      const elements = ['reader', 'qr-status', 'reiniciar-btn', 'camera-controls'];
      
      if (enabled) {
        statusSpan.textContent = 'Activada';
        statusSpan.style.color = 'var(--primary)';
        elements.slice(0, 2).forEach(id => document.getElementById(id).style.display = 'block');
        document.getElementById('reiniciar-btn').style.display = 'block';
        cargarCamaras();
      } else {
        statusSpan.textContent = 'Desactivada';
        statusSpan.style.color = '#999';
        detenerEscaneo();
        elements.forEach(id => document.getElementById(id).style.display = 'none');
      }
    }
    
    function detenerEscaneo() {
      if (qrCodeReader && isScanning) {
        qrCodeReader.stop().then(() => {
          qrCodeReader = null;
          isScanning = false;
        }).catch(err => console.error('Error stopping scanner:', err));
      }
    }
    
    function cargarCamaras() {
      if (!cameraEnabled) return;
      
      Html5Qrcode.getCameras()
        .then(devices => {
          if (esMobile() && devices.length > 1) {
            mostrarSelectorCamara(devices);
          } else if (devices.length > 0) {
            selectedCameraId = devices.find(d => 
              d.label.toLowerCase().includes('back') || 
              d.label.toLowerCase().includes('rear')
            )?.id || devices[0].id;
            iniciarEscaneo();
          }
        })
        .catch(err => {
          console.error("Error getting cameras:", err);
          actualizarEstadoQR("‚ùå Error al detectar c√°maras", true);
        });
    }
    
    function mostrarSelectorCamara(devices) {
      const controlsDiv = document.getElementById('camera-controls');
      const select = document.getElementById('camera-select');
      
      select.innerHTML = '<option value="">Seleccione una c√°mara...</option>';
      
      devices.forEach((device, index) => {
        const option = document.createElement('option');
        option.value = device.id;
        
        let tipo = 'C√°mara ' + (index + 1);
        if (device.label.toLowerCase().includes('back') || device.label.toLowerCase().includes('rear')) {
          tipo = 'üì∑ C√°mara Trasera';
        } else if (device.label.toLowerCase().includes('front') || device.label.toLowerCase().includes('user')) {
          tipo = 'ü§≥ C√°mara Frontal';
        }
        
        option.textContent = tipo;
        select.appendChild(option);
      });
      
      controlsDiv.style.display = 'block';
      
      select.addEventListener('change', function() {
        if (this.value) {
          selectedCameraId = this.value;
          if (isScanning) {
            reiniciarQR();
          } else {
            iniciarEscaneo();
          }
        }
      });
      
      const rearCamera = devices.find(d => 
        d.label.toLowerCase().includes('back') || 
        d.label.toLowerCase().includes('rear')
      );
      if (rearCamera) {
        select.value = rearCamera.id;
        selectedCameraId = rearCamera.id;
        iniciarEscaneo();
      }
    }
    
    function iniciarEscaneo() {
      if (isScanning || !selectedCameraId || !cameraEnabled) return;
      
      const readerId = "reader";
      qrCodeReader = new Html5Qrcode(readerId);
      
      actualizarEstadoQR("üé• Iniciando c√°mara...");
      
      const config = { 
        fps: 10, 
        qrbox: { 
          width: Math.min(250, window.innerWidth * 0.7), 
          height: Math.min(250, window.innerWidth * 0.7) 
        }, 
        aspectRatio: 1.0 
      };
      
      qrCodeReader.start(
        selectedCameraId,
        config,
        (decodedText) => {
          actualizarEstadoQR("‚úÖ QR detectado correctamente");
          procesarQR(decodedText);
        },
        () => {}
      ).then(() => {
        isScanning = true;
        actualizarEstadoQR("üì∑ Escaneando... Acerca el c√≥digo QR");
      }).catch(err => {
        actualizarEstadoQR("‚ùå Error al acceder a la c√°mara", true);
        console.error("Error starting QR scanner:", err);
      });
    }
    
    function reiniciarQR() {
      detenerEscaneo();
      
      if (selectedCameraId && cameraEnabled) {
        setTimeout(iniciarEscaneo, 500);
      } else if (cameraEnabled) {
        setTimeout(cargarCamaras, 500);
      }
    }
    
    function procesarQR(textoQR) {
      const idEmpleado = textoQR.trim();
      document.getElementById("id").value = idEmpleado;
      buscarEmpleado(idEmpleado);
      mostrarRespuesta("üéØ ID cargado desde QR", "success");
    }
    
    function buscarEmpleado(id) {
      if (!id.trim()) {
        ocultarInfoEmpleado();
        return;
      }
      
      mostrarBusqueda();
      
      google.script.run
        .withSuccessHandler(function(resultado) {
          if (resultado.encontrado) {
            employeeData = resultado.datos;
            mostrarInfoEmpleado(resultado.datos);
            habilitarBotonRegistro();
          } else {
            ocultarInfoEmpleado();
            mostrarRespuesta("‚ö†Ô∏è " + resultado.mensaje, "warning");
            deshabilitarBotonRegistro();
          }
        })
        .withFailureHandler(function() {
          ocultarInfoEmpleado();
          mostrarRespuesta("‚ùå Error al buscar empleado", "error");
          deshabilitarBotonRegistro();
        })
        .buscarEmpleado(id);
    }
    
    function mostrarBusqueda() {
      const infoDiv = document.getElementById('employee-info');
      infoDiv.style.display = 'block';
      document.getElementById('employee-name').innerHTML = '<div class="loading"></div> Buscando...';
    }
    
    function mostrarInfoEmpleado(datos) {
      const infoDiv = document.getElementById('employee-info');
      infoDiv.style.display = 'block';
      document.getElementById('employee-name').textContent = datos.nombre;
      document.getElementById('employee-area').textContent = datos.area;
      document.getElementById('employee-position').textContent = datos.cargo;
    }
    
    function ocultarInfoEmpleado() {
      document.getElementById('employee-info').style.display = 'none';
      employeeData = null;
    }
    
    function habilitarBotonRegistro() {
      document.getElementById('btn-submit').disabled = false;
    }
    
    function deshabilitarBotonRegistro() {
      document.getElementById('btn-submit').disabled = true;
    }
    
    function mostrarRespuesta(mensaje, tipo) {
      const respuesta = document.getElementById("respuesta");
      respuesta.textContent = mensaje;
      respuesta.className = tipo;
      respuesta.style.display = "block";
      
      if (tipo === "success") {
        setTimeout(() => {
          respuesta.style.display = "none";
        }, 5000);
      }
    }
    
    function enviarFormulario(event) {
      event.preventDefault();
      
      const id = document.getElementById("id").value.trim();
      const estado = document.getElementById("estado").value;
      
      if (!id || !employeeData) {
        mostrarRespuesta("‚ùå Por favor ingrese un ID v√°lido", "error");
        return;
      }
      
      const btnSubmit = document.getElementById("btn-submit");
      btnSubmit.innerHTML = '<div class="loading"></div> Registrando...';
      btnSubmit.disabled = true;
      
      const data = { 
        id: id,
        nombre: employeeData.nombre,
        area: employeeData.area,
        cargo: employeeData.cargo,
        estado: estado 
      };
      
      google.script.run
        .withSuccessHandler(function(resultado) {
          btnSubmit.innerHTML = '‚úÖ Registrar Asistencia';
          
          if (resultado.exito) {
            const mensaje = `‚úÖ ${estado} registrado para ${employeeData.nombre} a las ${resultado.hora}`;
            mostrarRespuesta(mensaje, "success");
            
            document.getElementById("formulario").reset();
            document.getElementById("estado").value = "INGRESO";
            ocultarInfoEmpleado();
            deshabilitarBotonRegistro();
            
          } else {
            mostrarRespuesta(resultado.mensaje, "warning");
            habilitarBotonRegistro();
          }
        })
        .withFailureHandler(function() {
          btnSubmit.innerHTML = '‚úÖ Registrar Asistencia';
          habilitarBotonRegistro();
          mostrarRespuesta("‚ùå Error de conexi√≥n", "error");
        })
        .registrarAsistencia(data);
    }
    
    document.getElementById("formulario").addEventListener("submit", enviarFormulario);
    
    document.getElementById("id").addEventListener("input", function(e) {
      const id = e.target.value.trim();
      
      if (searchTimeout) clearTimeout(searchTimeout);
      
      if (id.length > 0) {
        ocultarInfoEmpleado();
        deshabilitarBotonRegistro();
        searchTimeout = setTimeout(() => buscarEmpleado(id), 1500);
      }
    });
    
    document.getElementById("camera-toggle").addEventListener("change", function(e) {
      toggleCamera(e.target.checked);
    });
    
    window.addEventListener('load', function() {
      actualizarReloj();
      setInterval(actualizarReloj, 1000);
      setTimeout(() => {
        if (cameraEnabled) {
          cargarCamaras();
        }
      }, 1000);
    });
    
    window.addEventListener('beforeunload', function() {
      detenerEscaneo();
    });
    
    window.addEventListener('resize', function() {
      if (isScanning) {
        reiniciarQR();
      }
    });
    
    window.addEventListener('orientationchange', function() {
      setTimeout(() => {
        if (isScanning) {
          reiniciarQR();
        }
      }, 500);
    });
  </script>
</body>
</html>